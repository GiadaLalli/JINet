<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
</head>

<body>
  <div style="display: flex; flex-direction: column; align-items: center;">
    <fieldset style="display: flex; flex-direction: row; justify-content: space-evenly;">
      <legend>Controls</legend>
      <label for="script">Your script here:</label>
      <input type="file" name="script" id="script-file" disabled />
      <input type="button" name="data" id="data-folder" onclick="mount_data_dir()" value="Select data folder"
        disabled />
      <input id="runButton1" type="button" onclick="run_my_script()" value="Run my shit" disabled />
      <input type="button" value="FS Sync" onclick="window.nativeFS.syncfs()" disabled />
      <input type="button" value="Interrupt" disabled />
    </fieldset>
    <fieldset id="parameters" style="display: flex; flex-direction: column; align-items: flex-start;" disabled>
      <legend>Script parameters</legend>
    </fieldset>
    <div id="results">
      <h3>Result</h3>
    </div>
  </div>
  <script type="text/javascript">
    async function main() {
      document.querySelector("#runButton1").disabled = true;
      let pyodide = await loadPyodide();
      window.pyodide = pyodide;
      setup_file_input();
      await pyodide.loadPackage(["numpy", "pandas", "micropip", "scikit-learn"]);
      const version = `
            import sys
            sys.version
        `;
      console.log(pyodide.runPython(version));
      const startup = `
        import micropip
        await micropip.install('plotly')

        print("Python is ready...")
        `;
      await pyodide.runPythonAsync(startup);
      document.querySelector("#data-folder").disabled = false;
    }
    main();

    function setup_file_input() {
      const scriptElement = document.querySelector("#script-file");

      scriptElement.addEventListener("change", () => {
        if (scriptElement.files.length === 1) {
          const scriptReader = new FileReader();
          scriptReader.onload = (evt) => {
            pyodide.FS.writeFile("script.py", evt.target.result, { encoding: "utf8" });
            inspect_my_script();
            document.querySelector("#runButton1").disabled = false;
          };
          scriptReader.readAsText(scriptElement.files[0]);
        }
      })
    }

    async function mount_data_dir() {
      const dirHandle = await showDirectoryPicker();
      if ((await dirHandle.queryPermission({ mode: "readwrite" })) !== "granted") {
        if ((await dirHandle.requestPermission({ mode: "readwrite" })) !== "granted") {
          throw Error("Unable to access your data directory");
        }
      }

      const nativeFS = await pyodide.mountNativeFS("/data", dirHandle);
      window.nativeFS = nativeFS;
      document.querySelector("#script-file").disabled = false;
    }

    function run_my_script() {
      const results = document.querySelector("#results");
      let mypkg = pyodide.pyimport("script");
      let data = `/data/${document.querySelector("input[type='radio'][name='data']:checked").value}`;
      let x = document.querySelector("#x").value;
      let y = document.querySelector("#y").value;
      let target = document.querySelector("#target").value;
      const imageHtml = mypkg.main(data, x, y, target);
      const range = document.createRange();
      range.selectNode(results);
      const docFrag = range.createContextualFragment(imageHtml);
      results.appendChild(docFrag);
    }

    function inspect_my_script() {
      const inspectimpl = `from inspect import signature
def data_types(fun):
  sig = signature(fun)
  return {"parameters": {param: sig.parameters[param].annotation.__qualname__ for param in sig.parameters}, "returns": sig.return_annotation.__qualname__}`;
      pyodide.FS.writeFile("inspector.py", inspectimpl, { encoding: 'utf8' });
      let inspect = pyodide.pyimport("inspector").data_types;
      const signature = inspect(pyodide.pyimport("script").main);
      let returns = signature.get('returns');
      let params = signature.get('parameters').toJs();
      const parametersElement = document.querySelector("#parameters");
      params.forEach((dtype, name) => {
        switch (dtype) {
          case 'int': {
            const input = document.createElement("input");
            input.type = "number";
            input.id = name;
            input.step = 1;
            const el = document.createElement("fieldset");
            const title = document.createElement("legend");
            title.innerHTML = name;
            el.appendChild(title);
            el.appendChild(input);
            parametersElement.appendChild(el);
            break;
          }
          case 'str': {
            const input = document.createElement("input");
            input.type = "text";
            input.id = name;
            const el = document.createElement("fieldset");
            const title = document.createElement("legend");
            title.innerHTML = name;
            el.appendChild(title);
            el.appendChild(input);
            parametersElement.appendChild(el);
            break;
          }
          case 'Path': {
            const el = document.createElement("fieldset");
            const title = document.createElement("legend");
            title.innerHTML = name;
            el.appendChild(title);
            pyodide.FS.readdir("/data").filter((entry) => ![".", ".."].includes(entry)).forEach((entry) => {
              const file = document.createElement("input");
              file.type = "radio";
              file.id = `${name}${entry}`;
              file.value = entry;
              file.name = name;
              const div = document.createElement("div");
              div.appendChild(file);
              const label = document.createElement("label");
              label.setAttribute("for", `${name}${entry}`);
              label.innerHTML = entry;
              div.appendChild(label);
              el.appendChild(div);
            });
            parametersElement.appendChild(el);
            break;
          }
        }
      });
      parametersElement.disabled = false;
    }
  </script>
</body>

</html>