{% extends "package-run.html" %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
{% endblock %}

{% block main %}
{{ super() }}
<script type="text/javascript">
  const loaderdiv = document.querySelector("#loader");
  const parametersdiv = document.querySelector("#parameters");
  const datafolderbutton = document.querySelector("#data-folder");
  const runbutton = document.querySelector("#run-package");
  const fieldsparent = document.querySelector("#parameter-fields");
  const resultdiv = document.querySelector("#result");
  const cancelbutton = document.querySelector("#cancel-run-package");
  let pathPrefix = "";

  function addFileSelectors(files) {
    Array.from(document.querySelectorAll("div[data-parameter=path]"))
      .map((pathinput) => {
        files.forEach((file) => {
          const container = document.createElement("div");
          const input = document.createElement("input");
          input.type = "radio";
          input.name = pathinput.dataset.parameterName;
          input.value = file;
          input.id = `${pathinput.dataset.parameterName}-${file}`;
          container.appendChild(input);
          const label = document.createElement("label");
          label.htmlFor = `${pathinput.dataset.parameterName}-${file}`;
          label.innerHTML = file;
          container.appendChild(label);
          pathinput.appendChild(container);
        })
      });
  }

  let interruptBuffer = new Uint8Array(new SharedArrayBuffer(1));
  const worker = new Worker("/static/python-runtime.js");
  worker.onmessage = (evt) => {
    const {msg, value} = evt.data;
    switch (msg) {
    case "error": {
      console.error(value);
      break;
    }
    case "source": {
      loaderdiv.style.display = "none";
      parametersdiv.style.display = "flex";
      break;
    }
    case "datadir": {
      datafolderbutton.disabled = true;
      fieldsparent.style.display = "flex";
      runbutton.style.display = "block";
      addFileSelectors(value.files);
      pathPrefix = value.prefix;
      break;
    }
      
    case "run": {
      loaderdiv.style.display = "none";

      {% if iface.output == "output-html" %}
      const range = document.createRange();
      range.selectNode(resultdiv);
      resultdiv.appendChild(range.createContextualFragment(value));
      {% elif iface.output == "output-file" %}
      worker.postMessage({msg: "read", value});
      {% endif %}

      resultdiv.style.display = "flex";
      break;
    }
    case "read": {
      const download = document.createElement("a");
      download.setAttribute("class", "uk-button uk-button-primary");
      download.href = window.URL.createObjectURL(value.data);
      download.download = value.filename;
      resultdiv.appendChild(download);
      break;
    }
    }
  };
  worker.postMessage({msg: "interrupt_buffer", value: interruptBuffer});
  worker.postMessage({msg: "source", value: "/packages/file?package={{package}}"});

  datafolderbutton.addEventListener("click", async () => {
    const dirHandle = await showDirectoryPicker();
    if ((await dirHandle.queryPermission({ mode: "read" })) !== "granted") {
      if ((await dirHandle.requestPermission({ mode: "read" })) !== "granted") {
        throw Error("Unable to access your data directory");
      }
    }
    worker.postMessage({msg: "datadir", value: dirHandle});
  });

  runbutton.addEventListener("click", async () => {
    parametersdiv.style.display = "none";
    document.querySelector("#loader p").innerText = "Running...";
    loaderdiv.style.display = "block";
    cancelbutton.style.display = "block";

    // Clear the interrupt buffer
    interruptBuffer[0] = 0;

    worker.postMessage({
      msg: "run",
      value: {
        entry: "{{iface.entrypoint}}",
        parameters: [
          {% for parameter in iface.parameters %}
          {% if parameter.type == "string" %}
          document.querySelector("#parameter-{{parameter.name}}").value,
          {% elif parameter.type == "int" %}

          {% elif parameter.type == "path" %}
          `${pathPrefix}/${document.querySelector("input[type='radio'][name='parameter-{{parameter.name}}']:checked").value}`,
          {% endif %}
          {% endfor %}
        ]
      }
    })
  });

  cancelbutton.addEventListener("click", () => {
    interruptBuffer[0] = 2;
    cancelbutton.style.display = "none";
    loaderdiv.style.display = "none";
    parametersdiv.style.display = "flex";
  });
</script>
{% endblock %}
